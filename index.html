<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ (Sankalp)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Gotu&family=Yatra+One&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            /* SANATAN THEME */
            --bhagwa: #ff9933;         
            --maroon: #800000;         
            --soft-cream: #fff5e6;     
            --bg-gradient: linear-gradient(135deg, #ff9933 0%, #ff5e62 100%);
            --success-green: #1a6b36;  
            --text-dark: #2d3436;
            --alert-red: #c0392b;
        }

        body {
            font-family: 'Gotu', sans-serif;
            background: var(--bg-gradient);
            margin: 0;
            padding: 10px;
            color: var(--text-dark);
            min-height: 100vh;
            padding-bottom: 80px; 
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* --- UI STYLES (App Interface) --- */
        .main-header {
            background: #ffffff;
            border-radius: 12px;
            padding: 15px;
            border-bottom: 5px solid var(--maroon);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: flex; flex-direction: column; gap: 10px;
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .app-name { font-family: 'Yatra One', cursive; font-size: 30px; color: var(--maroon); margin: 0; }

        .date-picker-wrapper input {
            padding: 6px 10px; border: 2px solid var(--bhagwa); background: var(--soft-cream);
            border-radius: 6px; font-size: 14px; font-weight: 600; color: var(--maroon);
            font-family: 'Gotu', sans-serif; outline: none;
        }

        .panchang-strip {
            background: #fff0e0; padding: 8px; border-radius: 8px; text-align: center;
            font-size: 15px; font-weight: 600; color: #444; border: 1px dashed var(--bhagwa);
        }
        .panchang-highlight { color: var(--maroon); font-weight: bold; font-family: 'Yatra One', cursive; }

        .tab-container { display: flex; gap: 8px; }
        .tab-btn {
            flex: 1; padding: 10px; border: 1px solid rgba(255,255,255,0.4);
            background: rgba(255, 255, 255, 0.25); color: white; border-radius: 8px;
            font-weight: 700; cursor: pointer; transition: 0.2s; font-family: 'Gotu', sans-serif;
        }
        .tab-btn.active { background: white; color: var(--maroon); }

        .input-card {
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 10px; 
            border-top: 4px solid var(--bhagwa);
        }
        .input-row { display: flex; gap: 8px; }
        input[type="text"] {
            padding: 10px; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; outline: none; flex: 1;
            font-family: 'Gotu', sans-serif; background: #fafafa;
        }
        input[type="text"]:focus { border-color: var(--bhagwa); background: white; }

        button.add-btn {
            background: var(--maroon); color: white; border: none; padding: 10px; border-radius: 6px; 
            font-size: 17px; cursor: pointer; width: 100%; font-weight: 700; font-family: 'Gotu', sans-serif;
            box-shadow: 0 4px 6px rgba(128, 0, 0, 0.3);
        }

        .person-card {
            background: white; border-radius: 10px; overflow: hidden; margin-bottom: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #eee;
        }
        .card-header {
            background: var(--soft-cream); padding: 8px 12px; border-left: 5px solid var(--maroon);
            font-weight: 700; color: var(--maroon); font-size: 17px;
        }

        ul { list-style: none; padding: 0; margin: 0; }
        li { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px; background: white; }

        li.new-task { border-left: 4px solid var(--bhagwa); }
        li.pending-1 { background-color: #fff0f0; border-left: 4px solid #ff7675; }
        li.pending-critical { background-color: #ffcccc; border-left: 4px solid #b71540; font-weight: 700; }
        li.done-task { border-left: 4px solid var(--success-green); background: #f0fdf4; }
        li.done-task .task-text { color: var(--success-green); font-weight: 600; }

        .sr-no { font-weight: bold; color: var(--maroon); margin-right: 5px; min-width: 25px; font-size: 15px; }
        .task-info { flex: 1; display: flex; flex-direction: column; }
        .task-text { font-size: 16px; line-height: 1.4; }
        .task-time { font-size: 12px; color: #888; margin-top: 3px; }

        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; display: inline-block; width: fit-content; margin-top: 4px; font-weight: bold; }
        .badge-orange { background: #e67e22; color: white; }
        .badge-red { background: #c0392b; color: white; }

        .btn-group { display: flex; gap: 5px; }
        .action-btn { width: 32px; height: 32px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .edit-btn { background: #fff5e6; color: var(--maroon); }
        .check-btn { background: #e8f5e9; color: var(--success-green); }
        .del-btn { background: #fde8e8; color: var(--alert-red); }
        .undo-btn { background: #fff0e0; color: var(--bhagwa); }

        .pdf-btn {
            width: 100%; padding: 12px; background: var(--maroon); color: white; 
            font-weight: 700; border: none; border-radius: 10px; margin-top: 5px; 
            font-family: 'Gotu', sans-serif; font-size: 16px; box-shadow: 0 4px 10px rgba(128, 0, 0, 0.3);
        }

        /* Floating Stats */
        .floating-stats {
            position: fixed; bottom: 30px; right: 20px; width: 85px; height: 85px;
            background: linear-gradient(135deg, var(--maroon), #600000); color: white;
            border-radius: 50%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            border: 3px solid var(--bhagwa); z-index: 1000;
        }
        .stat-numbers { font-family: 'Yatra One', cursive; font-size: 26px; margin-bottom: 2px; }
        .stat-label { font-size: 11px; font-weight: 600; color: var(--bhagwa); text-transform: uppercase; }

        /* --- PDF SPECIFIC STYLES (Hidden from UI) --- */
        #pdf-template { display: none; } /* Only used when generating PDF */

    </style>
</head>
<body>

<div id="loader" style="position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;z-index:2000;display:flex;justify-content:center;align-items:center;font-family:'Yatra One';color:#800000;font-size:24px;">‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</div>

<audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

<div class="floating-stats">
    <div class="stat-circle-content">
        <div class="stat-numbers">
            <span id="statDone">‡•¶</span><span style="opacity:0.6;font-size:20px;">/</span><span id="statTotal">‡•¶</span>
        </div>
        <div class="stat-label">‡§™‡•Ç‡§∞‡•ç‡§£</div>
    </div>
</div>

<div class="container">
    <div class="main-header">
        <div class="header-top">
            <h1 class="app-name">üö© ‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™</h1>
            <div style="display:flex; align-items:center;">
                <button class="action-btn" id="alarmToggle" style="margin-right:10px; border:2px solid #800000;">üîî</button>
                <div class="date-picker-wrapper"><input type="date" id="dateSelector"></div>
            </div>
        </div>
        <div class="panchang-strip" id="panchangText">‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</div>
    </div>

    <div class="tab-container">
        <button class="tab-btn active" id="btnPending" onclick="switchTab('pending')">‚è≥ ‡§¨‡§æ‡§ï‡•Ä (Pending)</button>
        <button class="tab-btn" id="btnHistory" onclick="switchTab('history')">‚úÖ ‡§™‡•Ç‡§∞‡•ç‡§£ (History)</button>
    </div>

    <div class="input-card" id="inputCard">
        <div class="input-row">
            <input type="text" id="personInput" placeholder="üë§ ‡§ï‡•ã‡§£‡§æ‡§ö‡•á ‡§ï‡§æ‡§Æ ‡§Ü‡§π‡•á?">
        </div>
        <div class="input-row">
            <input type="text" id="taskInput" placeholder="üìù ‡§ï‡§æ‡§Æ‡§æ‡§ö‡•á ‡§∏‡•ç‡§µ‡§∞‡•Ç‡§™ (Task)">
        </div>
        <button class="add-btn" id="addBtn">‡§®‡§µ‡•Ä‡§® ‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ (Add Task)</button>
    </div>

    <div id="mainList"></div>
    <button class="pdf-btn" id="dlBtn" onclick="generateProfessionalPDF()">üìÑ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Ü‡§£‡§ø ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ (PDF)</button>
</div>

<div id="pdf-template">
    <div style="padding: 20px; font-family: 'Gotu', sans-serif; color: #333; border: 5px solid #800000; height: 98%;">
        
        <div style="text-align: center; border-bottom: 2px solid #ff9933; padding-bottom: 10px; margin-bottom: 20px;">
            <h1 style="font-family: 'Yatra One'; color: #800000; margin: 0; font-size: 36px;">üö© ‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ - ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§Ö‡§π‡§µ‡§æ‡§≤</h1>
            <p style="margin: 5px 0; color: #555; font-size: 14px;">‡§§‡•Å‡§Æ‡§ö‡§æ ‡§µ‡•à‡§Ø‡§ï‡•ç‡§§‡§ø‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§ï</p>
            <div style="display: flex; justify-content: space-between; margin-top: 15px; font-weight: bold; background: #fff5e6; padding: 10px; border-radius: 5px;">
                <span id="pdf-date">‡§§‡§æ‡§∞‡•Ä‡§ñ: -</span>
                <span id="pdf-day">‡§µ‡§æ‡§∞: -</span>
                <span id="pdf-tithi">‡§§‡§ø‡§•‡•Ä: -</span>
            </div>
        </div>

        <div style="background: #f0f8ff; border: 1px solid #0056b3; border-radius: 8px; padding: 15px; margin-bottom: 25px;">
            <h3 style="margin-top: 0; color: #0056b3; font-family: 'Yatra One';">ü§ñ ‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ (Analysis)</h3>
            <div style="display: flex; justify-content: space-around; margin-bottom: 10px;">
                <div style="text-align: center;"><strong>‡§è‡§ï‡•Ç‡§£ ‡§ï‡§æ‡§Æ‡•á</strong><br><span id="an-total" style="font-size:20px;">‡•¶</span></div>
                <div style="text-align: center;"><strong>‡§™‡•Ç‡§∞‡•ç‡§£</strong><br><span id="an-done" style="font-size:20px; color:green;">‡•¶</span></div>
                <div style="text-align: center;"><strong>‡§¨‡§æ‡§ï‡•Ä</strong><br><span id="an-pending" style="font-size:20px; color:red;">‡•¶</span></div>
            </div>
            <hr style="border: 0; border-top: 1px solid #ccc;">
            <p><strong>üí° ‡§∏‡§≤‡•ç‡§≤‡§æ (Feedback):</strong> <span id="an-advice" style="color: #333; font-style: italic;">‡§°‡•á‡§ü‡§æ ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</span></p>
        </div>

        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            <thead>
                <tr style="background: #800000; color: white;">
                    <th style="padding: 10px; border: 1px solid #ddd;">‡§ï‡•ç‡§∞.</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">‡§ï‡•ã‡§£‡§æ‡§ö‡•á ‡§ï‡§æ‡§Æ</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">‡§ï‡§æ‡§Æ‡§æ‡§ö‡•á ‡§∏‡•ç‡§µ‡§∞‡•Ç‡§™</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">‡§µ‡•á‡§≥</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">‡§∏‡•ç‡§•‡§ø‡§§‡•Ä</th>
                </tr>
            </thead>
            <tbody id="pdf-table-body">
                </tbody>
        </table>

        <div style="position: absolute; bottom: 20px; width: 100%; text-align: center; font-size: 12px; color: #888;">
            Generated by Sankalp App ‚Ä¢ Be Productive
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDm85K2wDKT_uYOWndPJLOaWSudyppk8Ew",
      authDomain: "task-c106f.firebaseapp.com",
      projectId: "task-c106f",
      storageBucket: "task-c106f.firebasestorage.app",
      messagingSenderId: "569746777624",
      appId: "1:569746777624:web:59b0d52ea9ed3582d4456d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const tasksCol = collection(db, "tasks");

    const mainList = document.getElementById('mainList');
    const inputCard = document.getElementById('inputCard');
    const personInput = document.getElementById('personInput');
    const taskInput = document.getElementById('taskInput');
    const addBtn = document.getElementById('addBtn');
    const loader = document.getElementById('loader');
    const dateSelector = document.getElementById('dateSelector');
    const panchangText = document.getElementById('panchangText');
    const statDone = document.getElementById('statDone');
    const statTotal = document.getElementById('statTotal');
    const alarmToggle = document.getElementById('alarmToggle');
    const alarmSound = document.getElementById('alarmSound');

    let currentTab = 'pending'; 
    let allData = [];
    let isAlarmActive = false;
    let alarmInterval;

    // Helper: Marathi Numbers
    const toMarathiNums = (num) => {
        const marathiMap = { '0': '‡•¶', '1': '‡•ß', '2': '‡•®', '3': '‡•©', '4': '‡•™', '5': '‡•´', '6': '‡•¨', '7': '‡•≠', '8': '‡•Æ', '9': '‡•Ø' };
        return num.toString().split('').map(char => marathiMap[char] || char).join('');
    };

    // --- ALARM ---
    alarmToggle.addEventListener('click', () => {
        if (!("Notification" in window)) { alert("‡§¨‡•ç‡§∞‡§æ‡§â‡§ù‡§∞ ‡§∏‡§™‡•ã‡§∞‡•ç‡§ü ‡§®‡§æ‡§π‡•Ä."); return; }
        if (!isAlarmActive) {
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    isAlarmActive = true;
                    alarmToggle.style.backgroundColor = "#800000";
                    alarmToggle.style.color = "white";
                    alert("üîî ‡§®‡•ã‡§ü‡§ø‡§´‡§ø‡§ï‡•á‡§∂‡§® ‡§ö‡§æ‡§≤‡•Ç!");
                    checkPendingTasks();
                    alarmInterval = setInterval(checkPendingTasks, 60 * 60 * 1000); 
                }
            });
        } else {
            isAlarmActive = false;
            alarmToggle.style.backgroundColor = "transparent";
            alarmToggle.style.color = "#800000";
            clearInterval(alarmInterval);
            alert("üîï ‡§®‡•ã‡§ü‡§ø‡§´‡§ø‡§ï‡•á‡§∂‡§® ‡§¨‡§Ç‡§¶.");
        }
    });

    function checkPendingTasks() {
        if (!isAlarmActive) return;
        const pendingCount = allData.filter(t => !t.completed).length;
        if (pendingCount > 0) {
            alarmSound.play().catch(e => console.log("Audio needed"));
            new Notification("‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ ‡§Ö‡§≤‡§∞‡•ç‡§ü!", { body: `${toMarathiNums(pendingCount)} ‡§ï‡§æ‡§Æ‡•á ‡§¨‡§æ‡§ï‡•Ä ‡§Ü‡§π‡•á‡§§!` });
        }
    }

    // --- PANCHANG LOGIC ---
    const getTithi = (date) => {
        const knownNewMoon = new Date('2000-01-06T18:14:00Z'); 
        const cycleLength = 29.53058867;
        const diffDays = (date.getTime() - knownNewMoon.getTime()) / (1000 * 60 * 60 * 24);
        const age = (diffDays % cycleLength + cycleLength) % cycleLength;
        const tithiIndex = Math.floor((age / cycleLength) * 30) + 1;
        const paksha = (tithiIndex <= 15) ? "‡§∂‡•Å‡§ï‡•ç‡§≤ ‡§™‡§ï‡•ç‡§∑" : "‡§ï‡•É‡§∑‡•ç‡§£ ‡§™‡§ï‡•ç‡§∑";
        const tithiNames = ["", "‡§™‡•ç‡§∞‡§§‡§ø‡§™‡§¶‡§æ", "‡§¶‡•ç‡§µ‡§ø‡§§‡•Ä‡§Ø‡§æ", "‡§§‡•É‡§§‡•Ä‡§Ø‡§æ", "‡§ö‡§§‡•Å‡§∞‡•ç‡§•‡•Ä", "‡§™‡§Ç‡§ö‡§Æ‡•Ä", "‡§∑‡§∑‡•ç‡§†‡•Ä", "‡§∏‡§™‡•ç‡§§‡§Æ‡•Ä", "‡§Ö‡§∑‡•ç‡§ü‡§Æ‡•Ä", "‡§®‡§µ‡§Æ‡•Ä", "‡§¶‡§∂‡§Æ‡•Ä", "‡§è‡§ï‡§æ‡§¶‡§∂‡•Ä", "‡§¶‡•ç‡§µ‡§æ‡§¶‡§∂‡•Ä", "‡§§‡•ç‡§∞‡§Ø‡•ã‡§¶‡§∂‡•Ä", "‡§ö‡§§‡•Å‡§∞‡•ç‡§¶‡§∂‡•Ä", "‡§™‡•å‡§∞‡•ç‡§£‡§ø‡§Æ‡§æ/‡§Ö‡§Æ‡§æ‡§µ‡§æ‡§∏‡•ç‡§Ø‡§æ"];
        let tithiName = (tithiIndex === 15) ? "‡§™‡•å‡§∞‡•ç‡§£‡§ø‡§Æ‡§æ" : (tithiIndex === 30 || tithiIndex === 0) ? "‡§Ö‡§Æ‡§æ‡§µ‡§æ‡§∏‡•ç‡§Ø‡§æ" : tithiNames[(tithiIndex > 15) ? tithiIndex - 15 : tithiIndex];
        return `${paksha}, ${tithiName}`;
    };

    const updatePanchang = (dateStr) => {
        const d = new Date(dateStr);
        const dateFull = toMarathiNums(d.toLocaleDateString('mr-IN', { day: '2-digit', month: 'long', year: 'numeric' }));
        const dayName = d.toLocaleDateString('mr-IN', { weekday: 'long' });
        const tithi = getTithi(d);
        panchangText.innerHTML = `üìÖ <span class="panchang-highlight">${dateFull}</span> &nbsp;|&nbsp; <span class="panchang-highlight">${dayName}</span> &nbsp;|&nbsp; ${tithi}`;
    };

    const formatDate = (date) => {
        const d = new Date(date);
        let month = '' + (d.getMonth() + 1), day = '' + d.getDate(), year = d.getFullYear();
        if (month.length < 2) month = '0' + month; if (day.length < 2) day = '0' + day;
        return [year, month, day].join('-');
    };

    const formatTimeDisplay = (timestamp) => {
        const d = new Date(timestamp);
        return toMarathiNums(d.toLocaleString('en-IN', { hour: 'numeric', minute: '2-digit', hour12: true }));
    };

    // --- MAIN LOGIC ---
    const today = new Date();
    const todayStr = formatDate(today);
    dateSelector.value = todayStr;
    updatePanchang(todayStr);

    window.switchTab = (tabName) => {
        currentTab = tabName;
        document.getElementById('btnPending').className = `tab-btn ${tabName === 'pending' ? 'active' : ''}`;
        document.getElementById('btnHistory').className = `tab-btn ${tabName === 'history' ? 'active' : ''}`;
        inputCard.style.display = (tabName === 'history') ? 'none' : 'flex';
        renderUI();
    };

    const q = query(tasksCol);
    onSnapshot(q, (snapshot) => {
        allData = [];
        snapshot.forEach((docSnap) => { allData.push({ id: docSnap.id, ...docSnap.data() }); });
        renderUI();
        loader.style.display = 'none';
    });

    function renderUI() {
        mainList.innerHTML = '';
        const selectedDateStr = dateSelector.value;
        const isTodayView = (selectedDateStr === todayStr);

        // Filter Logic
        const filteredTasks = allData.filter(t => {
            const tDateStr = formatDate(t.createdAt);
            if (currentTab === 'pending') {
                return !t.completed && (isTodayView ? (tDateStr <= todayStr) : (tDateStr === selectedDateStr));
            } else {
                return t.completed && tDateStr === selectedDateStr;
            }
        });

        // Stats Logic
        let sTotal = 0, sDone = 0;
        allData.forEach(t => {
            const tDateStr = formatDate(t.createdAt);
            let relevant = isTodayView ? (tDateStr <= todayStr && (!t.completed || tDateStr === todayStr)) : (tDateStr === selectedDateStr);
            if (relevant) { sTotal++; if (t.completed) sDone++; }
        });
        statDone.innerText = toMarathiNums(sDone);
        statTotal.innerText = toMarathiNums(sTotal);

        // Render List
        const groupedData = {};
        filteredTasks.forEach(t => {
            const p = t.person || "General";
            if (!groupedData[p]) groupedData[p] = [];
            groupedData[p].push(t);
        });

        const sortedPeople = Object.keys(groupedData).sort();

        if (sortedPeople.length === 0) {
            mainList.innerHTML = `<div class="empty-msg">${currentTab === 'pending' ? '‡§ï‡§æ‡§π‡•Ä ‡§ï‡§æ‡§Æ ‡§¨‡§æ‡§ï‡•Ä ‡§®‡§æ‡§π‡•Ä üéâ' : '‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§æ‡§π‡•Ä üìÇ'}</div>`;
            return;
        }

        sortedPeople.forEach(person => {
            let tasks = groupedData[person];
            tasks.sort((a, b) => a.createdAt - b.createdAt);
            const card = document.createElement('div');
            card.className = 'person-card';
            let tasksHtml = '';
            let srNo = 1;

            tasks.forEach(t => {
                let liClass = t.completed ? 'done-task' : 'new-task';
                let timeStr = formatTimeDisplay(t.createdAt);
                
                // Urgency Logic
                if (!t.completed) {
                   const d1 = new Date(t.createdAt); d1.setHours(0,0,0,0);
                   const d2 = new Date(); d2.setHours(0,0,0,0);
                   const daysOld = Math.round((d2 - d1) / (1000*60*60*24));
                   if(daysOld > 0) liClass = daysOld > 2 ? 'pending-critical' : 'pending-1';
                }

                tasksHtml += `
                    <li class="${liClass}">
                        <div class="sr-no">${toMarathiNums(srNo++)}.</div>
                        <div class="task-info">
                            <span class="task-text">${t.text}</span>
                            <div class="task-time">üìÖ ${timeStr}</div>
                        </div>
                        <div class="btn-group">
                            <button class="action-btn edit-btn" onclick="editTask('${t.id}', '${t.text}')">‚úé</button>
                            ${!t.completed ? 
                                `<button class="action-btn check-btn" onclick="toggleStatus('${t.id}', true)">‚úî</button>` : 
                                `<button class="action-btn undo-btn" onclick="toggleStatus('${t.id}', false)">‚Ü∫</button>
                                 <button class="action-btn del-btn" onclick="secureDelete('${t.id}')">‚úï</button>`
                            }
                        </div>
                    </li>
                `;
            });
            card.innerHTML = `<div class="card-header">üë§ ${person}</div><ul>${tasksHtml}</ul>`;
            mainList.appendChild(card);
        });
    }

    // --- EVENTS ---
    dateSelector.addEventListener('change', () => { updatePanchang(dateSelector.value); renderUI(); });
    
    addBtn.addEventListener('click', async () => {
        if (!personInput.value.trim() || !taskInput.value.trim()) { alert("‡§®‡§æ‡§µ ‡§Ü‡§£‡§ø ‡§ï‡§æ‡§Æ ‡§¶‡•ã‡§®‡•ç‡§π‡•Ä ‡§≤‡§ø‡§π‡§æ!"); return; }
        const selDate = new Date(dateSelector.value);
        const now = new Date(); selDate.setHours(now.getHours(), now.getMinutes());
        addBtn.disabled = true;
        await addDoc(tasksCol, { text: taskInput.value.trim(), person: personInput.value.trim(), completed: false, createdAt: selDate.getTime() });
        taskInput.value = ''; addBtn.disabled = false;
    });

    window.secureDelete = async (id) => { if(prompt("‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° (2708):") === "2708") await deleteDoc(doc(db, "tasks", id)); else alert("‡§ö‡•Ç‡§ï!"); };
    window.toggleStatus = async (id, s) => { await updateDoc(doc(db, "tasks", id), { completed: s }); };
    window.editTask = async (id, old) => { const n = prompt("‡§¨‡§¶‡§≤ ‡§ï‡§∞‡§æ:", old); if(n) await updateDoc(doc(db, "tasks", id), { text: n.trim() }); };

    // --- PROFESSIONAL PDF GENERATION ---
    window.generateProfessionalPDF = () => {
        const btn = document.getElementById('dlBtn');
        btn.innerText = "PDF ‡§¨‡§®‡§µ‡§§ ‡§Ü‡§π‡•á..."; btn.disabled = true;

        // 1. Prepare Data for PDF Template
        const selDate = dateSelector.value;
        const d = new Date(selDate);
        document.getElementById('pdf-date').innerText = "‡§§‡§æ‡§∞‡•Ä‡§ñ: " + toMarathiNums(d.toLocaleDateString('mr-IN'));
        document.getElementById('pdf-day').innerText = "‡§µ‡§æ‡§∞: " + d.toLocaleDateString('mr-IN', { weekday: 'long' });
        document.getElementById('pdf-tithi').innerText = "‡§§‡§ø‡§•‡•Ä: " + getTithi(d);

        // 2. Filter Data for Report
        const reportTasks = allData.filter(t => formatDate(t.createdAt) === selDate || (!t.completed && selDate === todayStr));
        
        let total = reportTasks.length;
        let done = reportTasks.filter(t => t.completed).length;
        let pending = total - done;
        let percentage = total === 0 ? 0 : Math.round((done / total) * 100);

        // 3. Fill Analysis Stats
        document.getElementById('an-total').innerText = toMarathiNums(total);
        document.getElementById('an-done').innerText = toMarathiNums(done);
        document.getElementById('an-pending').innerText = toMarathiNums(pending);

        // 4. Generate Advice (Simulated AI)
        let advice = "";
        if (total === 0) advice = "‡§Ü‡§ú ‡§ï‡•ã‡§£‡§§‡•á‡§π‡•Ä ‡§ï‡§æ‡§Æ ‡§®‡•ã‡§Ç‡§¶‡§µ‡§≤‡•á ‡§®‡§æ‡§π‡•Ä. ‡§®‡§µ‡•Ä‡§® ‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ ‡§ï‡§∞‡§æ!";
        else if (percentage === 100) advice = "‡§Ö‡§§‡§ø‡§∂‡§Ø ‡§â‡§§‡•ç‡§§‡§Æ! ‡§§‡•Å‡§Æ‡•ç‡§π‡•Ä ‡§∏‡§∞‡•ç‡§µ ‡§ï‡§æ‡§Æ‡•á ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ï‡•á‡§≤‡•Ä ‡§Ü‡§π‡•á‡§§. üåü";
        else if (percentage >= 75) advice = "‡§ñ‡•Ç‡§™ ‡§õ‡§æ‡§® ‡§™‡•ç‡§∞‡§ó‡§§‡•Ä! ‡§Ø‡§∂‡§æ‡§ö‡•ç‡§Ø‡§æ ‡§ú‡§µ‡§≥ ‡§Ü‡§π‡§æ‡§§. üëç";
        else if (percentage >= 50) advice = "‡§ö‡§æ‡§≤‡•Ä ‡§™‡•ç‡§∞‡§ó‡§§‡•Ä ‡§Ü‡§π‡•á, ‡§™‡§£ ‡§Ö‡§ú‡•Ç‡§® ‡§µ‡•á‡§ó ‡§µ‡§æ‡§¢‡§µ‡§£‡•á ‡§ó‡§∞‡§ú‡•á‡§ö‡•á ‡§Ü‡§π‡•á.";
        else advice = "‡§≤‡§ï‡•ç‡§∑ ‡§¶‡•ç‡§Ø‡§æ! ‡§¨‡§∞‡•á‡§ö ‡§ï‡§æ‡§Æ ‡§¨‡§æ‡§ï‡•Ä ‡§Ü‡§π‡•á. ‡§µ‡•á‡§≥‡•á‡§ö‡•á ‡§®‡§ø‡§Ø‡•ã‡§ú‡§® ‡§ï‡§∞‡§æ. ‚ö†Ô∏è";
        document.getElementById('an-advice').innerText = advice;

        // 5. Build Table Rows
        const tbody = document.getElementById('pdf-table-body');
        tbody.innerHTML = '';
        if (reportTasks.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:20px;">‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§æ‡§π‡•Ä</td></tr>`;
        } else {
            reportTasks.forEach((t, index) => {
                const tr = document.createElement('tr');
                tr.style.backgroundColor = index % 2 === 0 ? '#fff' : '#f9f9f9';
                tr.innerHTML = `
                    <td style="padding:8px; border:1px solid #ddd; text-align:center;">${toMarathiNums(index + 1)}</td>
                    <td style="padding:8px; border:1px solid #ddd;">${t.person}</td>
                    <td style="padding:8px; border:1px solid #ddd;">${t.text}</td>
                    <td style="padding:8px; border:1px solid #ddd;">${formatTimeDisplay(t.createdAt)}</td>
                    <td style="padding:8px; border:1px solid #ddd; color:${t.completed ? 'green' : 'red'}; font-weight:bold;">
                        ${t.completed ? '‡§™‡•Ç‡§∞‡•ç‡§£' : '‡§¨‡§æ‡§ï‡•Ä'}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 6. Generate PDF
        const element = document.getElementById('pdf-template');
        element.style.display = 'block'; // Temporarily show

        const opt = {
            margin: 0.3,
            filename: `Sankalp_Report_${toMarathiNums(selDate)}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            element.style.display = 'none'; // Hide again
            btn.innerText = "üìÑ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü ‡§Ü‡§£‡§ø ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£ (PDF)";
            btn.disabled = false;
        });
    };
</script>

</body>
</html>
