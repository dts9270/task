<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ (Sankalp)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Gotu&family=Yatra+One&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            /* Sankalp Theme */
            --saffron: #ff9933;
            --maroon: #800000;
            --royal-blue: #002D62;
            --bg-gradient: linear-gradient(135deg, #ff9933 0%, #ff5e62 100%);
            --green: #16a34a;
            --red-alert: #dc2626;
            --text-dark: #2d3436;
        }

        body {
            font-family: 'Gotu', sans-serif;
            background: var(--bg-gradient);
            margin: 0;
            padding: 15px;
            color: var(--text-dark);
            min-height: 100vh;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* HEADER */
        .main-header {
            background: #ffffff;
            border-radius: 15px;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 5px solid var(--maroon);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            flex-wrap: wrap;
            gap: 10px;
        }

        .header-title h1 {
            margin: 0;
            font-family: 'Yatra One', cursive;
            font-size: 32px;
            color: var(--maroon);
            letter-spacing: 1px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .date-picker-container input {
            padding: 8px 12px;
            border: 2px solid var(--saffron);
            background: #fff5e6;
            border-radius: 8px;
            font-weight: 600;
            color: var(--maroon);
            cursor: pointer;
            font-family: 'Gotu', sans-serif;
            outline: none;
        }

        /* TABS */
        .tab-container { display: flex; gap: 10px; padding: 0 5px; }

        .tab-btn {
            flex: 1; padding: 12px;
            border: 2px solid rgba(255,255,255,0.4);
            background: rgba(255, 255, 255, 0.2); 
            color: white;
            border-radius: 10px; 
            font-weight: 700; 
            cursor: pointer; 
            transition: 0.3s;
            font-family: 'Gotu', sans-serif;
        }
        .tab-btn.active {
            background: white; 
            color: var(--maroon);
            border-color: white; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        /* INPUT */
        .input-card {
            background: white; padding: 20px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; gap: 12px;
            border-top: 5px solid var(--saffron);
        }
        .input-row { display: flex; gap: 10px; }
        
        input[type="text"] {
            padding: 12px; border: 2px solid #eee;
            border-radius: 8px; font-size: 16px; outline: none; flex: 1;
            font-family: 'Gotu', sans-serif;
            background: #fafafa;
        }
        input[type="text"]:focus { border-color: var(--saffron); background: white; }

        button.add-btn {
            background: var(--maroon); 
            color: white; border: none;
            padding: 12px; border-radius: 8px; 
            font-size: 18px; cursor: pointer;
            width: 100%; font-weight: 700; 
            font-family: 'Gotu', sans-serif;
            box-shadow: 0 4px 6px rgba(128, 0, 0, 0.3);
        }

        /* PERSON CARD & LIST */
        .person-card {
            background: white; border-radius: 12px; overflow: hidden;
            margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 1px solid #eee;
        }
        .card-header {
            background: #fff5e6;
            padding: 10px 15px;
            border-left: 5px solid var(--maroon);
            font-weight: 700; 
            color: var(--maroon);
            font-size: 18px;
        }

        ul { list-style: none; padding: 0; margin: 0; }
        
        li {
            padding: 12px 15px; border-bottom: 1px solid #f1f5f9;
            display: flex; align-items: center; gap: 10px; background: white;
        }

        /* COLORS */
        li.pending-1 { background-color: #fff1f2; border-left: 4px solid #fda4af; }
        li.pending-2 { background-color: #ffe4e6; border-left: 4px solid #f43f5e; }
        li.pending-critical { 
            background-color: #fee2e2; border-left: 4px solid #991b1b; 
            color: #7f1d1d; font-weight: 700;
        }
        li.new-task { border-left: 4px solid var(--saffron); }
        li.done-task { border-left: 4px solid var(--green); background: #f0fdf4; opacity: 1; }
        li.done-task .task-text { text-decoration: none; color: #15803d; font-weight: 600; }

        .sr-no { font-weight: bold; color: var(--maroon); margin-right: 5px; min-width: 20px; }
        .task-info { flex: 1; display: flex; flex-direction: column; }
        .task-text { font-size: 16px; line-height: 1.4; }
        
        .task-time {
            font-size: 12px; color: #888; margin-top: 4px; font-weight: 500;
            display: flex; align-items: center; gap: 4px;
        }
        
        .badge {
            font-size: 11px; padding: 3px 8px; border-radius: 4px; 
            display: inline-block; width: fit-content; margin-top: 5px;
            font-weight: bold; text-transform: uppercase;
        }
        .badge-red { background: #b91c1c; color: white; }
        .badge-orange { background: #c2410c; color: white; }

        .btn-group { display: flex; gap: 8px; }
        .action-btn {
            width: 34px; height: 34px; border-radius: 8px; border: none; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 15px;
        }
        .edit-btn { background: #eff6ff; color: var(--royal-blue); }
        .check-btn { background: #f0fdf4; color: var(--green); }
        .del-btn { background: #fef2f2; color: var(--red-alert); }
        .undo-btn { background: #fff7ed; color: var(--saffron); }

        /* PDF BTN */
        .pdf-btn {
            width: 100%; padding: 15px; 
            background: var(--royal-blue);
            color: white; font-weight: 700; border: none; 
            border-radius: 12px; margin-top: 10px;
            font-family: 'Gotu', sans-serif;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(0, 45, 98, 0.3);
        }

        #loader {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(255,255,255,0.98); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
            font-weight: 700; color: var(--maroon); font-size: 20px;
            font-family: 'Yatra One', cursive;
        }
        .empty-msg { text-align: center; color: #fff; margin-top: 30px; font-size: 18px; opacity: 0.9; }
    </style>
</head>
<body>

<div id="loader">‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</div>

<div class="container" id="contentToPrint">
    <div class="main-header">
        <div class="header-title">
            <h1>‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™</h1>
        </div>
        <div class="date-picker-container" data-html2canvas-ignore="true">
            <input type="date" id="dateSelector">
        </div>
    </div>

    <div class="tab-container" data-html2canvas-ignore="true">
        <button class="tab-btn active" id="btnPending" onclick="switchTab('pending')">‚è≥ ‡§¨‡§æ‡§ï‡•Ä (Pending)</button>
        <button class="tab-btn" id="btnHistory" onclick="switchTab('history')">‚úÖ ‡§™‡•Ç‡§∞‡•ç‡§£ (History)</button>
    </div>

    <div class="input-card" id="inputCard" data-html2canvas-ignore="true">
        <div class="input-row">
            <input type="text" id="personInput" placeholder="üë§ ‡§ï‡•ã‡§£‡§æ‡§ö‡•á ‡§ï‡§æ‡§Æ ‡§Ü‡§π‡•á?">
        </div>
        <div class="input-row">
            <input type="text" id="taskInput" placeholder="üìù ‡§ï‡§æ‡§Æ‡§æ‡§ö‡•á ‡§∏‡•ç‡§µ‡§∞‡•Ç‡§™ (Task)">
        </div>
        <button class="add-btn" id="addBtn">‡§®‡§µ‡•Ä‡§® ‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ (Add Task)</button>
    </div>

    <div id="mainList"></div>

    <button class="pdf-btn" id="dlBtn" onclick="downloadPDF()" data-html2canvas-ignore="true">üìÑ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§°‡§æ‡§ä‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ (PDF)</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, orderBy } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDm85K2wDKT_uYOWndPJLOaWSudyppk8Ew",
      authDomain: "task-c106f.firebaseapp.com",
      projectId: "task-c106f",
      storageBucket: "task-c106f.firebasestorage.app",
      messagingSenderId: "569746777624",
      appId: "1:569746777624:web:59b0d52ea9ed3582d4456d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const tasksCol = collection(db, "tasks");

    const mainList = document.getElementById('mainList');
    const inputCard = document.getElementById('inputCard');
    const personInput = document.getElementById('personInput');
    const taskInput = document.getElementById('taskInput');
    const addBtn = document.getElementById('addBtn');
    const loader = document.getElementById('loader');
    const dateSelector = document.getElementById('dateSelector');
    
    let currentTab = 'pending'; 
    let allData = [];

    const formatDate = (date) => {
        const d = new Date(date);
        let month = '' + (d.getMonth() + 1), day = '' + d.getDate(), year = d.getFullYear();
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        return [year, month, day].join('-');
    };

    const formatTimeDisplay = (timestamp) => {
        const d = new Date(timestamp);
        return d.toLocaleString('en-IN', {
            day: 'numeric', month: 'short',
            hour: 'numeric', minute: '2-digit', hour12: true
        });
    };

    const getDaysDiff = (date1, date2) => {
        const oneDay = 24 * 60 * 60 * 1000;
        const d1 = new Date(date1); d1.setHours(0,0,0,0);
        const d2 = new Date(date2); d2.setHours(0,0,0,0);
        return Math.round((d2 - d1) / oneDay);
    };

    const today = new Date();
    const todayStr = formatDate(today);
    dateSelector.value = todayStr;

    window.switchTab = (tabName) => {
        currentTab = tabName;
        document.getElementById('btnPending').className = `tab-btn ${tabName === 'pending' ? 'active' : ''}`;
        document.getElementById('btnHistory').className = `tab-btn ${tabName === 'history' ? 'active' : ''}`;
        
        if(tabName === 'history') inputCard.style.display = 'none';
        else inputCard.style.display = 'flex';

        renderUI();
    };

    const q = query(tasksCol);

    onSnapshot(q, (snapshot) => {
        allData = [];
        snapshot.forEach((docSnap) => {
            allData.push({ id: docSnap.id, ...docSnap.data() });
        });
        renderUI();
        loader.style.display = 'none';
    });

    function renderUI() {
        mainList.innerHTML = '';
        const selectedDateStr = dateSelector.value;
        const isTodayView = (selectedDateStr === todayStr);

        const filteredTasks = allData.filter(t => {
            const tDateStr = formatDate(t.createdAt);
            
            if (currentTab === 'pending') {
                if (t.completed) return false; 
                if (isTodayView) {
                    return tDateStr === todayStr || tDateStr < todayStr;
                } else {
                    return tDateStr === selectedDateStr;
                }
            } else {
                return t.completed && tDateStr === selectedDateStr;
            }
        });

        const groupedData = {};
        filteredTasks.forEach(t => {
            const pName = t.person || "General";
            if (!groupedData[pName]) groupedData[pName] = [];
            groupedData[pName].push(t);
        });

        const sortedPeople = Object.keys(groupedData).sort();

        if (sortedPeople.length === 0) {
            mainList.innerHTML = `<div class="empty-msg">${currentTab === 'pending' ? '‡§ï‡§æ‡§π‡•Ä ‡§ï‡§æ‡§Æ ‡§¨‡§æ‡§ï‡•Ä ‡§®‡§æ‡§π‡•Ä üéâ' : '‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§° ‡§®‡§æ‡§π‡•Ä üìÇ'}</div>`;
            return;
        }

        sortedPeople.forEach(person => {
            let tasks = groupedData[person];
            tasks.sort((a, b) => a.createdAt - b.createdAt);

            const card = document.createElement('div');
            card.className = 'person-card';

            let tasksHtml = '';
            let srNo = 1; 
            
            tasks.forEach(t => {
                let liClass = '';
                let badgeHtml = '';
                let timeStr = formatTimeDisplay(t.createdAt);
                
                if (t.completed) {
                    liClass = 'done-task';
                } else {
                    const daysOld = getDaysDiff(t.createdAt, today);
                    if (daysOld === 0) liClass = 'new-task'; 
                    else if (daysOld === 1) {
                        liClass = 'pending-1'; 
                        badgeHtml = `<span class="badge badge-orange">1 ‡§¶‡§ø‡§µ‡§∏ ‡§≤‡•á‡§ü</span>`;
                    } else if (daysOld === 2) {
                        liClass = 'pending-2'; 
                        badgeHtml = `<span class="badge badge-red">2 ‡§¶‡§ø‡§µ‡§∏ ‡§≤‡•á‡§ü</span>`;
                    } else if (daysOld > 2) {
                        liClass = 'pending-critical'; 
                        badgeHtml = `<span class="badge badge-red">‚ö†Ô∏è ${daysOld} ‡§¶‡§ø‡§µ‡§∏ ‡§≤‡•á‡§ü</span>`;
                    }
                }

                // Add data-html2canvas-ignore to button group so buttons don't print in PDF
                tasksHtml += `
                    <li class="${liClass}">
                        <div class="sr-no">${srNo++}.</div>
                        <div class="task-info">
                            <span class="task-text">${t.text}</span>
                            <div class="task-time">üìÖ ${timeStr}</div>
                            ${badgeHtml}
                        </div>
                        <div class="btn-group" data-html2canvas-ignore="true">
                            <button class="action-btn edit-btn" onclick="editTask('${t.id}', '${t.text}')">‚úé</button>
                            
                            ${!t.completed ? 
                                `<button class="action-btn check-btn" onclick="toggleStatus('${t.id}', true)">‚úî</button>` : 
                                `<button class="action-btn undo-btn" onclick="toggleStatus('${t.id}', false)">‚Ü∫</button>
                                 <button class="action-btn del-btn" onclick="secureDelete('${t.id}')">‚úï</button>`
                            }
                        </div>
                    </li>
                `;
            });

            card.innerHTML = `
                <div class="card-header">üë§ ${person}</div>
                <ul>${tasksHtml}</ul>
            `;
            mainList.appendChild(card);
        });
    }

    dateSelector.addEventListener('change', renderUI);

    addBtn.addEventListener('click', async () => {
        const pName = personInput.value.trim();
        const tText = taskInput.value.trim();
        if (!pName || !tText) { alert("‡§®‡§æ‡§µ ‡§Ü‡§£‡§ø ‡§ï‡§æ‡§Æ ‡§¶‡•ã‡§®‡•ç‡§π‡•Ä ‡§≤‡§ø‡§π‡§æ!"); return; }

        const selDate = new Date(dateSelector.value);
        const now = new Date();
        selDate.setHours(now.getHours(), now.getMinutes(), now.getSeconds());

        addBtn.disabled = true;
        await addDoc(tasksCol, { 
            text: tText, person: pName, completed: false, createdAt: selDate.getTime() 
        });
        taskInput.value = '';
        addBtn.disabled = false;
    });

    window.secureDelete = async (id) => {
        const password = prompt("‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§° (2708) ‡§ü‡§æ‡§ï‡§æ:");
        if (password === "2708") {
            if(confirm("‡§ï‡§æ‡§Ø‡§Æ‡§ö‡•á ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§æ‡§Ø‡§ö‡•á ‡§ï‡§æ?")) await deleteDoc(doc(db, "tasks", id));
        } else if (password !== null) alert("‡§ö‡•Å‡§ï‡•Ä‡§ö‡§æ ‡§™‡§æ‡§∏‡§µ‡§∞‡•ç‡§°!");
    };

    window.toggleStatus = async (id, status) => { await updateDoc(doc(db, "tasks", id), { completed: status }); };
    window.editTask = async (id, oldText) => {
        const newText = prompt("‡§¨‡§¶‡§≤ ‡§ï‡§∞‡§æ:", oldText);
        if (newText && newText.trim() !== "") await updateDoc(doc(db, "tasks", id), { text: newText.trim() });
    };

    // --- NEW DIRECT DOWNLOAD FUNCTION ---
    window.downloadPDF = () => {
        const element = document.getElementById('contentToPrint');
        const btn = document.getElementById('dlBtn');
        
        btn.innerText = "PDF ‡§¨‡§®‡§µ‡§§ ‡§Ü‡§π‡•á...";
        btn.disabled = true;

        const opt = {
          margin:       0.2,
          filename:     `Sankalp_List_${new Date().toLocaleDateString()}.pdf`,
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2 },
          jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            btn.innerText = "üìÑ ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§°‡§æ‡§ä‡§®‡§≤‡•ã‡§° ‡§ï‡§∞‡§æ (PDF)";
            btn.disabled = false;
        });
    };

</script>

</body>
</html>
