<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ (Sankalp)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Gotu&family=Yatra+One&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --bhagwa: #ff9933; --maroon: #800000; --soft-cream: #fff5e6;
            --bg-gradient: linear-gradient(135deg, #ff9933 0%, #ff5e62 100%);
            --success-green: #1a6b36; --text-dark: #2d3436;
        }

        body {
            font-family: 'Gotu', sans-serif; background: var(--bg-gradient);
            margin: 0; padding: 10px; color: var(--text-dark);
            min-height: 100vh; padding-bottom: 120px;
        }

        .container { max-width: 700px; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }

        /* Header */
        .main-header {
            background: #ffffff; border-radius: 12px; padding: 15px;
            border-bottom: 5px solid var(--maroon); box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            text-align: center; position: relative;
        }
        .app-name { font-family: 'Yatra One', cursive; font-size: 36px; color: var(--maroon); margin: 0; }
        
        .alarm-btn {
            position: absolute; top: 15px; right: 15px; width: 35px; height: 35px;
            border-radius: 50%; border: 2px solid var(--maroon); background: transparent;
            color: var(--maroon); cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .panchang-strip {
            background: #fff0e0; padding: 8px; border-radius: 8px; margin-top: 10px;
            font-weight: 600; color: #444; border: 1px dashed var(--bhagwa); font-size: 14px;
        }
        .panchang-highlight { color: var(--maroon); font-weight: bold; font-family: 'Yatra One'; }

        /* Tabs */
        .tab-container { display: flex; gap: 8px; }
        .tab-btn {
            flex: 1; padding: 12px; border: 1px solid rgba(255,255,255,0.4);
            background: rgba(255, 255, 255, 0.25); color: white; border-radius: 8px;
            font-weight: 700; cursor: pointer;
        }
        .tab-btn.active { background: white; color: var(--maroon); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

        /* Input */
        .input-card {
            background: white; padding: 15px; border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15); display: flex; flex-direction: column; gap: 10px;
        }
        input[type="text"] {
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px;
            font-size: 16px; outline: none; box-sizing: border-box; font-family: 'Gotu';
        }
        button.add-btn {
            background: var(--maroon); color: white; border: none; padding: 12px; border-radius: 6px;
            font-size: 18px; cursor: pointer; width: 100%; font-weight: 700; font-family: 'Gotu';
        }

        /* List */
        .person-card { background: white; border-radius: 10px; overflow: hidden; margin-bottom: 12px; }
        .card-header { background: var(--soft-cream); padding: 8px 12px; border-left: 5px solid var(--maroon); font-weight: 700; color: var(--maroon); }
        ul { list-style: none; padding: 0; margin: 0; }
        li { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: center; gap: 10px; }
        li.done-task { background: #f0fdf4; opacity: 0.8; }
        li.done-task span { text-decoration: line-through; color: green; }
        
        .btn-group { display: flex; gap: 5px; }
        .action-btn { width: 30px; height: 30px; border-radius: 5px; border: none; cursor: pointer; }
        .check-btn { background: #e8f5e9; color: green; } .del-btn { background: #fee2e2; color: red; }

        /* Floating Widgets */
        .floating-stats {
            position: fixed; bottom: 30px; right: 20px; width: 80px; height: 80px;
            background: linear-gradient(135deg, var(--maroon), #600000); color: white;
            border-radius: 50%; display: flex; flex-direction: column; justify-content: center; align-items: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); z-index: 1000;
        }
        .stat-numbers { font-family: 'Yatra One'; font-size: 24px; }
        
        .floating-date {
            position: fixed; bottom: 30px; left: 20px; background: white;
            padding: 10px 15px; border-radius: 30px; border: 3px solid var(--maroon);
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); z-index: 1000; display: flex; align-items: center;
        }
        .floating-date input { border: none; outline: none; font-size: 16px; color: var(--maroon); font-family: 'Yatra One'; width: 130px; }

        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98); z-index: 2000;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Yatra One'; color: var(--maroon); font-size: 24px;
            flex-direction: column;
        }
        #pdf-template { display: none; }
        .pdf-btn { width: 100%; padding: 12px; background: var(--maroon); color: white; border: none; border-radius: 10px; font-weight: 700; }
    </style>
</head>
<body>

<div id="loader">
    <div>‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...</div>
    <div id="errorMsg" style="font-size:14px; color:red; margin-top:10px;"></div>
</div>

<div class="floating-stats">
    <div class="stat-numbers"><span id="statDone">‡•¶</span>/<span id="statTotal">‡•¶</span></div>
    <div style="font-size:10px;">‡§™‡•Ç‡§∞‡•ç‡§£</div>
</div>

<div class="floating-date">
    <span>üìÖ</span>
    <input type="date" id="dateSelector">
</div>

<div class="container">
    <div class="main-header">
        <button class="alarm-btn" id="alarmToggle">üîî</button>
        <h1 class="app-name">üö© ‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™</h1>
        <div class="panchang-strip" id="panchangText">..</div>
    </div>

    <div class="tab-container">
        <button class="tab-btn active" id="btnPending" onclick="switchTab('pending')">‚è≥ ‡§¨‡§æ‡§ï‡•Ä</button>
        <button class="tab-btn" id="btnHistory" onclick="switchTab('history')">‚úÖ ‡§™‡•Ç‡§∞‡•ç‡§£</button>
    </div>

    <div class="input-card" id="inputCard">
        <input type="text" id="personInput" placeholder="üë§ ‡§ï‡•ã‡§£‡§æ‡§ö‡•á ‡§ï‡§æ‡§Æ?">
        <input type="text" id="taskInput" placeholder="üìù ‡§ï‡§æ‡§Ø ‡§ï‡§æ‡§Æ ‡§Ü‡§π‡•á?" style="margin-top:10px;">
        <button class="add-btn" id="addBtn" style="margin-top:10px;">‡§®‡§µ‡•Ä‡§® ‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ (Add)</button>
    </div>

    <div id="mainList"></div>
    <button class="pdf-btn" id="dlBtn" onclick="genPDF()">üìÑ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü (PDF)</button>
</div>

<div id="pdf-template"><div style="padding:20px;border:5px solid #800000;"><h1 style="text-align:center;color:#800000;">‡§∏‡§Ç‡§ï‡§≤‡•ç‡§™ ‡§∞‡§ø‡§™‡•ã‡§∞‡•ç‡§ü</h1><table id="pdf-table" style="width:100%;border-collapse:collapse;"></table></div></div>

<script type="module">
    // --- IMPORT FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query } 
    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyDm85K2wDKT_uYOWndPJLOaWSudyppk8Ew",
      authDomain: "task-c106f.firebaseapp.com",
      projectId: "task-c106f",
      storageBucket: "task-c106f.firebasestorage.app",
      messagingSenderId: "569746777624",
      appId: "1:569746777624:web:59b0d52ea9ed3582d4456d"
    };

    // --- FORCE START (3 Sec Timeout) ---
    setTimeout(() => {
        const l = document.getElementById('loader');
        if(l && l.style.display !== 'none') {
            l.style.display = 'none';
            console.log("Forced Loader Hide");
        }
    }, 4000);

    // --- INIT ---
    let db, tasksCol;
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        tasksCol = collection(db, "tasks");
    } catch(e) {
        document.getElementById('errorMsg').innerText = "Firebase Error: " + e.message;
    }

    // --- UTILS ---
    const toMarathiNums = (n) => n.toString().split('').map(c => {'0':'‡•¶','1':'‡•ß','2':'‡•®','3':'‡•©','4':'‡•™','5':'‡•´','6':'‡•¨','7':'‡•≠','8':'‡•Æ','9':'‡•Ø'}[c]||c).join('');
    const formatDate = (d) => { let m=''+(d.getMonth()+1), da=''+d.getDate(), y=d.getFullYear(); if(m.length<2)m='0'+m; if(da.length<2)da='0'+da; return [y,m,da].join('-'); };
    
    // --- STATE ---
    let allData = [], currentTab = 'pending';
    const dateSelector = document.getElementById('dateSelector');
    dateSelector.value = formatDate(new Date());

    // --- RENDER ---
    function render() {
        const list = document.getElementById('mainList');
        list.innerHTML = '';
        const selDate = dateSelector.value;
        const today = formatDate(new Date());
        
        const filtered = allData.filter(t => {
            const tDate = formatDate(new Date(t.createdAt));
            if(currentTab === 'pending') return !t.completed && (selDate === today ? tDate <= today : tDate === selDate);
            return t.completed;
        });

        // Stats
        let done=0, total=0;
        allData.forEach(t => {
            const tDate = formatDate(new Date(t.createdAt));
            if(selDate === today ? (tDate <= today || t.completed && tDate===today) : tDate === selDate) {
                total++; if(t.completed) done++;
            }
        });
        document.getElementById('statDone').innerText = toMarathiNums(done);
        document.getElementById('statTotal').innerText = toMarathiNums(total);

        // Grouping
        const groups = {};
        filtered.forEach(t => { const p = t.person || 'General'; if(!groups[p]) groups[p]=[]; groups[p].push(t); });

        if(filtered.length === 0) { list.innerHTML = '<div style="text-align:center;margin-top:20px;color:#888;">‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§®‡§æ‡§π‡•Ä</div>'; return; }

        Object.keys(groups).sort().forEach(p => {
            let tasks = groups[p];
            tasks.sort((a,b) => b.createdAt - a.createdAt);
            const card = document.createElement('div'); card.className = 'person-card';
            let html = `<div class="card-header">üë§ ${p}</div><ul>`;
            
            tasks.forEach((t, i) => {
                html += `
                <li class="${t.completed?'done-task':''}">
                    <span style="font-weight:bold; color:#800000; margin-right:5px;">${toMarathiNums(i+1)}.</span>
                    <span style="flex:1;">${t.text}</span>
                    <div class="btn-group">
                        ${!t.completed ? 
                        `<button class="action-btn check-btn" onclick="upd('${t.id}',true)">‚úî</button>` : 
                        `<button class="action-btn del-btn" onclick="del('${t.id}')">‚úï</button>`}
                    </div>
                </li>`;
            });
            html += `</ul>`;
            card.innerHTML = html;
            list.appendChild(card);
        });
    }

    // --- LISTENERS ---
    const q = query(tasksCol);
    onSnapshot(q, (snap) => {
        allData = [];
        snap.forEach(d => allData.push({id: d.id, ...d.data()}));
        render();
        document.getElementById('loader').style.display = 'none';
    }, (err) => {
        document.getElementById('errorMsg').innerText = "Data Load Failed: " + err.message;
    });

    document.getElementById('addBtn').addEventListener('click', async () => {
        const p = document.getElementById('personInput').value.trim();
        const t = document.getElementById('taskInput').value.trim();
        if(!p || !t) return alert('‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§≠‡§∞‡§æ');
        
        const d = new Date(dateSelector.value); 
        d.setHours(new Date().getHours());
        
        try {
            await addDoc(tasksCol, { person: p, text: t, completed: false, createdAt: d.getTime() });
            document.getElementById('taskInput').value = '';
        } catch(e) { alert("Error Adding: " + e.message); }
    });

    window.switchTab = (t) => {
        currentTab = t;
        document.getElementById('btnPending').className = `tab-btn ${t==='pending'?'active':''}`;
        document.getElementById('btnHistory').className = `tab-btn ${t==='history'?'active':''}`;
        document.getElementById('inputCard').style.display = t==='history'?'none':'flex';
        render();
    }

    window.upd = async (id, s) => { await updateDoc(doc(db, "tasks", id), {completed: s}); };
    window.del = async (id) => { if(confirm('Delete?')) await deleteDoc(doc(db, "tasks", id)); };
    dateSelector.addEventListener('change', render);

    // PDF
    window.genPDF = () => {
        const rows = allData.filter(t => currentTab==='history' ? t.completed : !t.completed)
            .map((t,i) => `<tr><td style="padding:5px;border:1px solid #ccc;">${i+1}</td><td style="padding:5px;border:1px solid #ccc;">${t.person}</td><td style="padding:5px;border:1px solid #ccc;">${t.text}</td></tr>`).join('');
        document.getElementById('pdf-table').innerHTML = rows;
        const e = document.getElementById('pdf-template'); e.style.display='block';
        html2pdf().from(e).save().then(() => e.style.display='none');
    };
</script>
</body>
</html>
